#!/usr/bin/env node
var optimist = require("optimist"),
client   = require("..").client, 
cfg,
fs = require("fs")



var cfgPath = process.cwd() + "/chunnel.json";

if(fs.existsSync(cfgPath)) {
  cfg = require(cfgPath);
  var server = cfg.server;
  for(var proxy in cfg.tunnel) {
    client.connect({
      server: server,
      proxy: proxy,
      domain: cfg.tunnel[proxy]
    });
  }
} else {



  var argv = optimist.
  usage('Usage: $0 [localhost:port] ...').
  demand(["server"]).
  default("server", "127.0.0.1:9526").
  argv

  function parsePortOrProxy(portOrProxy) {
    var proxy;
    if(isNaN(Number(portOrProxy))) {
      proxy = portOrProxy;
    } else {
      proxy = "127.0.0.1:" + portOrProxy;
    }
    return proxy;
  }

  for(var i = argv._.length; i--;) {

    var argParts = argv._[i].split("@"),
    proxy = parsePortOrProxy(argParts.shift()),
    domain = parsePortOrProxy(argParts.shift() || proxy);


    client.connect({
      server: argv.server,
      domain: domain,
      proxy: proxy
    }); 
  }
}




