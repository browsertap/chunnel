var express = require("express");
exports.plugin = function(loader) {
	var server = express(),
	httpPort = loader.params("http.port"),
	publicDir = loader.params("publicDir"),
	http = loader.params("http") || {};

	if(http.compress) server.use(express.compress());

	if(http.xhr)
	server.use(function(req, res, next) {
    	res.header("Access-Control-Allow-Origin", req.headers.origin);
    	res.header("Access-Control-Allow-Headers", "X-Requested-With");
    	res.header("Access-Control-Allow-Credentials", "true");
    	next();
	});
		
	server.use(express.bodyParser());

	if(http.cookies) {
		server.use(express.cookieParser());
		server.use(express.session({ secret: loader.params("http.session.secret") || "node-auth-token-sessid" }));
	}

	if(publicDir) express.use(express.static(publicDir));
	if(httpPort) server.connection = server.listen(httpPort);

	server.express = express;

	return server;
}